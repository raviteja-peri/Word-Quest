crossorigin resource sharing crossorigin resource sharing wc recommendation  january  this version httpwwwworgtrreccors latest version httpwwwworgtrcors previous versions httpwwwworgtrprcors httpwwwworgtrcrcors httpwwwworgtrwdcors httpwwwworgtrwdcors httpwwwworgtrwdcors httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrwdaccesscontrol httpwwwworgtrnoteaccesscontrol editor anne van kesteren formerly of opera software asa annevk@annevknl please note there may be errata for this document the english version of this specification is the only normative version nonnormative translations may also be available copyright   wc mit ercim keio beihang all rights reserved wc liability trademark and document use rules apply abstract this document defines a mechanism to enable clientside crossorigin requests specifications that enable an api to make crossorigin requests to resources can use the algorithms defined by this specification if such an api is used on httpexampleorg resources a resource on httphelloworldexample can opt in using the mechanism described by this specification eg specifying accesscontrolalloworigin httpexampleorg as response header which would allow that resource to be fetched crossorigin from httpexampleorg status of this document this section describes the status of this document at the time of its publication other documents may supersede this document a list of current wc publications and the latest revision of this technical report can be found in the wc technical reports index at httpwwwworgtr this document has been reviewed by wc members by software developers and by other wc groups and interested parties and is endorsed by the director as a wc recommendation it is a stable document and may be used as reference material or cited from another document wcs role in making the recommendation is to draw attention to the specification and to promote its widespread deployment this enhances the functionality and interoperability of the web this wc recommendation of cors was produced jointly by the web applications webapps and web application security webappsec working groups and published by the webappsec working group no changes were made since the previous publication as proposed recommendation if you wish to make comments regarding this document please send them to publicwebappsec@worg subscribe archives this document was produced by groups operating under the  february  wc patent policy wc maintains a public list of any patent disclosures for the webappsec wg and the webapps wg made in connection with the deliverables of the group that page also includes instructions for disclosing a patent an individual who has actual knowledge of a patent which the individual believes contains essential claims must disclose the information in accordance with section  of the wc patent policy by publishing this recommendation wc expects that the functionality specified in this crossorigin resource sharing recommendation will not be affected by changes to html or to http status code  as those specifications proceed to recommendation and rfc status respectively an initial implementation report is available with a supplement for changes since candidate recommendation table of contents  introduction  conformance  terminology  security considerations  syntax  accesscontrolalloworigin response header  accesscontrolallowcredentials response header  accesscontrolexposeheaders response header  accesscontrolmaxage response header  accesscontrolallowmethods response header  accesscontrolallowheaders response header  origin request header  accesscontrolrequestmethod request header  accesscontrolrequestheaders request header  resource processing model  simple crossorigin request actual request and redirects  preflight request  security  implementation considerations  user agent processing model  crossorigin request  handling a response to a crossorigin request  crossorigin request status  source origin  simple crossorigin request  crossorigin request with preflight  preflight result cache  generic crossorigin request algorithms  resource sharing check  security  cors api specification advice  constructing a crossorigin request  dealing with same origin to crossorigin redirects  dealing with the crossorigin request status  security references acknowledgments  introduction this section is nonnormative user agents commonly apply sameorigin restrictions to network requests these restrictions prevent a clientside web application running from one origin from obtaining data retrieved from another origin and also limit unsafe http requests that can be automatically launched toward destinations that differ from the running applications origin in user agents that follow this pattern network requests typically include user credentials with crossorigin requests including http authentication and cookie information this specification extends this model in several ways a response can include an accesscontrolalloworigin header with the origin of where the request originated from as the value to allow access to the resources contents the user agent validates that the value and origin of where the request originated match user agents can discover via a preflight request whether a crossorigin resource is prepared to accept requests using a nonsimple method from a given origin this is again validated by the user agent serverside applications are enabled to discover that an http request was deemed a crossorigin request by the user agent through the origin header this extension enables serverside applications to enforce limitations eg returning nothing on the crossorigin requests that they are willing to service this specification is a building block for other specifications socalled cors api specifications which define how this specification is used examples are serversent events and xmlhttprequest eventsource xhr the cors wiki page provides more background information about this document if a resource author has a simple text resource residing at httpexamplecomhello which contains the string hello world and would like httphelloworldexample to be able to access it the response combined with a header introduced by this specification could look as follows accesscontrolalloworigin httphelloworldexamplehello world using xmlhttprequest a clientside web application on httphelloworldexample can access this resource as follows var client  new xmlhttprequestclientopenget httpexamplecomhelloclientonreadystatechange  function   do something  clientsend it gets slightly more complicated if the resource author wants to be able to handle crossorigin requests using methods other than simple methods in that case the author needs to reply to a preflight request that uses the options method and then needs to handle the actual request that uses the desired method delete in this example and give an appropriate response the response to the preflight request could have the following headers specified accesscontrolalloworigin httphelloworldexampleaccesscontrolmaxage accesscontrolallowmethods put delete the accesscontrolmaxage header indicates how long the response can be cached so that for subsequent requests within the specified time no preflight request has to be made the accesscontrolallowmethods header indicates the methods that can be used in the actual request the response to the actual request can simply contain this header accesscontrolalloworigin httphelloworldexample the complexity of invoking the additional preflight request is the task of the user agent using xmlhttprequest again and assuming the application were hosted at httpcalendarexampleapp the author could use the following ecmascript snippet function deleteitemitemid updateui   var client  new xmlhttprequest  clientopendelete httpcalendarexampleapp  clientonload  updateui  clientonerror  updateui  clientonabort  updateui  clientsendid  itemid  conformance this specification is written for resource authors and user agents it includes advice for specifications that define apis that use the crossorigin request algorithm defined in this specification  cors api specifications  and the general security considerations section includes some advice for clientside web application authors as well as sections and appendices marked as nonnormative all diagrams examples and notes in this specification are nonnormative everything else in this specification is normative in this specification the words must and may are to be interpreted as described in rfc  rfc requirements phrased in the imperative as part of algorithms eg terminate the algorithm are to be interpreted with the meaning of the key word eg must used in introducing the algorithm a conformant resource is one that implements all the requirements listed in this specification that are applicable to resources a conformant user agent is one that implements all the requirements listed in this specification that are applicable to user agents user agents and resource authors may employ any algorithm to implement this specification so long as the end result is indistinguishable from the result that would be obtained by the specifications algorithms  terminology some terminology in this specification is from the web origin concept html http and uri origin html http uri terminology is generally defined throughout the specification however the few definitions that did not really fit anywhere else are defined here instead comparing two strings in a casesensitive manner means comparing them exactly codepoint for codepoint comparing two strings in an ascii caseinsensitive manner means comparing them exactly codepoint for codepoint except that the characters in the range u latin capital letter a to ua latin capital letter z and the corresponding characters in the range u latin small letter a to ua latin small letter z are considered to also match converting a string to ascii lowercase means replacing all characters in the range u latin capital letter a to ua latin capital letter z with the corresponding characters in the range u latin small letter a to ua latin small letter z the term user credentials for the purposes of this specification means cookies http authentication and clientside ssl certificates that would be sent based on the user agents previous interactions with the origin specifically it does not refer to proxy authentication or the origin header cookies the term crossorigin is used to mean non same origin a method is said to be a simple method if it is a casesensitive match for one of the following get head post a header is said to be a simple header if the header field name is an ascii caseinsensitive match for accept acceptlanguage or contentlanguage or if it is an ascii caseinsensitive match for contenttype and the header field value media type excluding parameters is an ascii caseinsensitive match for applicationxwwwformurlencoded multipartformdata or textplain a header is said to be a simple response header if the header field name is an ascii caseinsensitive match for one of the following cachecontrol contentlanguage contenttype expires lastmodified pragma when parsing a header the header must be parsed per the corresponding abnf production in the syntax section if the header does not match the production it is said that header parsing failed  security considerations this section is nonnormative security requirements and considerations are listed throughout this specification this section lists advice that did not fit anywhere else a simple crossorigin request has been defined as congruent with those which may be generated by currently deployed user agents that do not conform to this specification simple crossorigin requests generated outside this specification such as crossorigin form submissions using get or post or crossorigin get requests resulting from script elements typically include user credentials so resources conforming to this specification must always be prepared to expect simple crossorigin requests with credentials because of this resources for which simple requests have significance other than retrieval must protect themselves from crosssite request forgery csrf by requiring the inclusion of an unguessable token in the explicitly provided content of the request csrf this specification defines how to authorize an instance of an application from a foreign origin executing in the user agent to access the representation of the resource in an http response certain types of resources should not attempt to specify particular authorized origins but instead either deny or allow all origins a resource that is not useful to applications from other origins such as a login page ought not to return an accesscontrolalloworigin header the resource still must protect itself against csrf attacks such as by requiring the inclusion of an unguessable token in the explicitly provided content of the request the security properties of such resources are unaffected by useragents conformant to this specification a resource that is publicly accessible with no access control checks can always safely return an accesscontrolalloworigin header whose value is  a get response whose entity body happens to parse as ecmascript can return an accesscontrolalloworigin header whose value is  provided there are no sensitive comments as it can be accessed crossorigin using an html script element if needed such resources can implement access control and csrf protections as described above requests made with user credentials or the origin header require special consideration when requests have significance other than retrieval and when relying on the origin header resources must be careful to distinguish between authorizing a request including its sideeffects and authorizing access to the representation of that resource in the response authorization for a request should be performed using only the intersection of the authority of the user and the requesting origins it is often appropriate for resources to require an authorization ceremony which explicitly asks for a user to consent that crossorigin requests with credentials be honored from a given origin in such cases passing security tokens explicitly as part of the crossorigin request can remove any ambiguity as to the scope of authorization oauth is an example of this pattern oauth use of user credentials in a crossorigin request is appropriate when a crossorigin request with credentials as defined in this specification is used to substitute for alternate methods of authenticated resource sharing such as servertoserver back channels jsonp or crossdocument messaging jsonp html this substitution can expose additional attack surface in some cases as a crosssite scripting vulnerability in the requesting origin can allow elevation of privileges against the requested resource when compared to a servertoserver back channel as a substitute for jsonpstyle crossorigin credentialed requests use of this specification significantly improves the security posture of the requesting application as it provides crossorigin data access whereas jsonp operates via crossorigin codeinjection as a substitute for crossorigin communication techniques relying on loading a resource with credentials into an html iframe element and subsequently employing crossdocument messaging or other crossorigin side channels this specification provides a roughly equivalent security posture again data received from origins that are not completely trusted has to be validated to conform to expected formats and authorized values for requests to resources that have no significance other than retrieval and where the credentials are used only to provide userspecific customization for otherwise publicly accessible information in this case restricting access to certain origins may protect user privacy by preventing customizations from being used to identify a user except at authorized origins when this specification is used for requests which have significance other than retrieval and which involve coordination between or data originating from more than two origins eg between resources enabling editing printing and storage each at distinct origins requests ought to set the omit credentials flag and resources ought to perform authorization using security tokens explicitly provided in the content of the request especially if the origins are not all mutually and completely trusted in such multiorigin scenarios a malicious resource at one of the origins may be able to enlist the useragent as a confused deputy and elevate its privileges by abusing user credentials sent with crossorigin requests avoiding such attacks requires that the coordinating applications have explicit knowledge of the scope of privilege for each origin and that all parameters and instructions received are carefully validated at each step in the coordination to ensure that effects implied do not exceed the authority of the originating principal confused given the difficulty of avoiding such vulnerabilities in multiorigin interactions it is recommended that instead of using user credentials automatically attached to the request by the user agent security tokens which specify the particular capabilities and resources authorized be passed as part of the explicit content of a request oauth again provides an example of such a pattern authors of clientside web applications are strongly encouraged to validate content retrieved from a crossorigin resource as it might be harmful web applications that are not uniquely identified by specific host names andor mapped to specific ports do not necessarily have a unique origin and thus will not be able to securely utilize the mechanism defined in this specification this is because an origin is composed of only the scheme hostname and port for example a web application whose url is of the type exampleorgappname and the appname portion is necessary to distinguish the web application from other web applications also running at exampleorg will be unable to securely employ the mechanism defined in this specification mapping web applications to distinct origins is vital for secure web applications  syntax this section defines the syntax of the new headers this specification introduces it also provides a short description of the function of each header the resource processing model section details how resources are to use these headers in a response likewise the user agent processing model section details how user agents are to use these headers the abnf syntax used in this section is from http http http is used as abnf basis to ensure that the new headers have equivalent parsing rules to those introduced in that specification http currently does not make leading ows implied in header value definitions but that form is assumed here  accesscontrolalloworigin response header the accesscontrolalloworigin header indicates whether a resource can be shared based by returning the value of the origin request header  or null in the response abnf accesscontrolalloworigin  accesscontrolalloworigin  originlistornull   in practice the originlistornull production is more constrained rather than allowing a spaceseparated list of origins it is either a single origin or the string null  accesscontrolallowcredentials response header the accesscontrolallowcredentials header indicates whether the response to request can be exposed when the omit credentials flag is unset when part of the response to a preflight request it indicates that the actual request can include user credentials abnf accesscontrolallowcredentials accesscontrolallowcredentials  true                            true x  true casesensitive  accesscontrolexposeheaders response header the accesscontrolexposeheaders header indicates which headers are safe to expose to the api of a cors api specification abnf accesscontrolexposeheaders  accesscontrolexposeheaders  fieldname  accesscontrolmaxage response header the accesscontrolmaxage header indicates how long the results of a preflight request can be cached in a preflight result cache abnf accesscontrolmaxage  accesscontrolmaxage  deltaseconds  accesscontrolallowmethods response header the accesscontrolallowmethods header indicates as part of the response to a preflight request which methods can be used during the actual request the allow header is not relevant for the purposes of the cors protocol abnf accesscontrolallowmethods accesscontrolallowmethods  method  accesscontrolallowheaders response header the accesscontrolallowheaders header indicates as part of the response to a preflight request which header field names can be used during the actual request abnf accesscontrolallowheaders accesscontrolallowheaders  fieldname  origin request header the origin header indicates where the crossorigin request or preflight request originates from origin  accesscontrolrequestmethod request header the accesscontrolrequestmethod header indicates which method will be used in the actual request as part of the preflight request abnf accesscontrolrequestmethod accesscontrolrequestmethod  method  accesscontrolrequestheaders request header the accesscontrolrequestheaders header indicates which headers will be used in the actual request as part of the preflight request abnf accesscontrolrequestheaders accesscontrolrequestheaders  fieldname  resource processing model this section describes the processing models that resources have to implement each type of request a resource might have to deal with is described in its own subsection the resource sharing policy described by this specification is bound to a particular resource for the purposes of this section each resource is bound to the following a list of origins consisting of zero or more origins that are allowed access to the resource this can include the origin of the resource itself though be aware that requests to crossorigin resources can be redirected back to the resource a list of methods consisting of zero or more methods that are supported by the resource a list of headers consisting of zero or more header field names that are supported by the resource a list of exposed headers consisting of zero or more header field names of headers other than the simple response headers that the resource might use and can be exposed a supports credentials flag that indicates whether the resource supports user credentials in the request it is true when the resource does and false otherwise  simple crossorigin request actual request and redirects in response to a simple crossorigin request or actual request the resource indicates whether or not to share the response if the resource has been relocated it indicates whether to share its new url resources must use the following set of steps to determine which additional headers to use in the response if the origin header is not present terminate this set of steps the request is outside the scope of this specification if the value of the origin header is not a casesensitive match for any of the values in list of origins do not set any additional headers and terminate this set of steps always matching is acceptable since the list of origins can be unbounded if the resource supports credentials add a single accesscontrolalloworigin header with the value of the origin header as value and add a single accesscontrolallowcredentials header with the casesensitive string true as value otherwise add a single accesscontrolalloworigin header with either the value of the origin header or the string  as value the string  cannot be used for a resource that supports credentials if the list of exposed headers is not empty add one or more accesscontrolexposeheaders headers with as values the header field names given in the list of exposed headers by not adding the appropriate headers resource can also clear the preflight result cache of all entries where origin is a casesensitive match for the value of the origin header and url is a casesensitive match for the url of the resource  preflight request in response to a preflight request the resource indicates which methods and headers other than simple methods and simple headers it is willing to handle and whether it supports credentials resources must use the following set of steps to determine which additional headers to use in the response if the origin header is not present terminate this set of steps the request is outside the scope of this specification if the value of the origin header is not a casesensitive match for any of the values in list of origins do not set any additional headers and terminate this set of steps always matching is acceptable since the list of origins can be unbounded the origin header can only contain a single origin as the user agent will not follow redirects let method be the value as result of parsing the accesscontrolrequestmethod header if there is no accesscontrolrequestmethod header or if parsing failed do not set any additional headers and terminate this set of steps the request is outside the scope of this specification let header fieldnames be the values as result of parsing the accesscontrolrequestheaders headers if there are no accesscontrolrequestheaders headers let header fieldnames be the empty list if parsing failed do not set any additional headers and terminate this set of steps the request is outside the scope of this specification if method is not a casesensitive match for any of the values in list of methods do not set any additional headers and terminate this set of steps always matching is acceptable since the list of methods can be unbounded if any of the header fieldnames is not a ascii caseinsensitive match for any of the values in list of headers do not set any additional headers and terminate this set of steps always matching is acceptable since the list of headers can be unbounded if the resource supports credentials add a single accesscontrolalloworigin header with the value of the origin header as value and add a single accesscontrolallowcredentials header with the casesensitive string true as value otherwise add a single accesscontrolalloworigin header with either the value of the origin header or the string  as value the string  cannot be used for a resource that supports credentials optionally add a single accesscontrolmaxage header with as value the amount of seconds the user agent is allowed to cache the result of the request if method is a simple method this step may be skipped add one or more accesscontrolallowmethods headers consisting of a subset of the list of methods if a method is a simple method it does not need to be listed but this is not prohibited since the list of methods can be unbounded simply returning the method indicated by accesscontrolrequestmethod if supported can be enough if each of the header fieldnames is a simple header and none is contenttype this step may be skipped add one or more accesscontrolallowheaders headers consisting of a subset of the list of headers if a header field name is a simple header and is not contenttype it is not required to be listed contenttype is to be listed as only a subset of its values makes it qualify as simple header since the list of headers can be unbounded simply returning supported headers from accesscontrolallowheaders can be enough  security this section is nonnormative resource authors are strongly encouraged to ensure that requests using safe methods eg get or options have no side effects so potential attackers cannot modify the users data easily if resources are set up like this attackers would effectively have to be on the list of origins to do harm in addition to checking the origin header resource authors are strongly encouraged to also check the host header that is make sure that the host name provided by that header matches the host name of the server on which the resource resides this will provide protection against dns rebinding attacks to provide integrity protection of resource sharing policy statements usage of ssltls is encouraged  implementation considerations this section is nonnormative resources that wish to enable themselves to be shared with multiple origins but do not respond uniformly with  must in practice generate the accesscontrolalloworigin header dynamically in response to every request they wish to allow as a consequence authors of such resources should send a vary origin http header or provide other appropriate control directives to prevent caching of such responses which may be inaccurate if reused acrossorigins  user agent processing model this section describes the processing models that user agents have to implement the processing models in this sections need to be referenced by a cors api specification that defines when the algorithm is invoked and how the return values are to be handled the processing models are not suitable for standalone use  crossorigin request the crossorigin request algorithm takes the following parameters request url the url to be fetched the request url is modified in face of redirects request method the method for the request get unless explicitly set author request headers a list of headers set by authors for the request empty unless explicitly set request entity body the entity body for the request missing unless explicitly set source origin the origin of the request due to the specifics of some apis this cannot be defined in a generic way and therefore it has to be provided as argument referrer source either a document or url used to determine the referer header manual redirect flag set when redirects are not to be automatically followed omit credentials flag set when user credentials are to be excluded in the request and when cookies are to be ignored in its response force preflight flag set when a preflight request is required the crossorigin request algorithm can be used by cors api specifications who wish to allow crossorigin requests for the network apis they define cors api specifications are free to limit the abilities of a crossorigin request eg the omit credentials flag could always be set when the crossorigin request algorithm is invoked these steps must be followed if for some reason the user agent does not want to make the request terminate this algorithm and set the crossorigin request status to network error the request url could have been blacklisted by the user in some fashion if the following conditions are true follow the simple crossorigin request algorithm the request method is a simple method and the force preflight flag is unset each of the author request headers is a simple header or author request headers is empty otherwise follow the crossorigin request with preflight algorithm crossorigin requests using a method that is simple with author request headers that are not simple will have a preflight request to ensure that the resource can handle those headers similarly to requests using a method that is not a simple method  handling a response to a crossorigin request user agents must filter out all response headers other than those that are a simple response header or of which the field name is an ascii caseinsensitive match for one of the values of the accesscontrolexposeheaders headers if any before exposing response headers to apis defined in cors api specifications the getresponseheader method of xmlhttprequest will therefore not expose any header not indicated above  crossorigin request status each crossorigin request has an associated crossorigin request status that cors api specifications that enable an api to make crossorigin requests can hook into it can take at most two distinct values over the course of a crossorigin request the values are preflight complete the user agent is about to make the actual request success the resource can be shared abort error the user aborted the request network error the resource cannot be shared also used when a dns error tls negotiation failure or other type of network error occurs this does not include http responses that indicate some type of error such as http status code   source origin the source origin is the initial origin that user agents must use for the origin header it can be modified during the redirect steps  simple crossorigin request the steps below describe what user agents must do for a simple crossorigin request apply the make a request steps and observe the request rules below while making the request if the manual redirect flag is unset and the response has an http status code of     or  apply the redirect steps if the end user cancels the request apply the abort steps if there is a network error in case of dns errors tls negotiation failure or other type of network errors apply the network error steps do not request any kind of end user interaction this does not include http responses that indicate some type of error such as http status code  otherwise perform a resource sharing check if it returns fail apply the network error steps otherwise if it returns pass terminate this algorithm and set the crossorigin request status to success do not actually terminate the request  crossorigin request with preflight to protect resources against crossorigin requests that could not originate from certain user agents before this specification existed a preflight request is made to ensure that the resource is aware of this specification the result of this request is stored in a preflight result cache the steps below describe what user agents must do for a crossorigin request with preflight this is a request to a non sameorigin url that first needs to be authorized using either a preflight result cache entry or a preflight request go to the next step if the following conditions are true for request method there either is a method cache match or it is a simple method and the force preflight flag is unset for every header of author request headers there either is a header cache match for the field name or it is a simple header otherwise make a preflight request fetch the request url from origin source origin using referrer source as override referrer source with the manual redirect flag and the block cookies flag set using the method options and with the following additional constraints include an accesscontrolrequestmethod header with as header field value the request method even when that is a simple method if author request headers is not empty include an accesscontrolrequestheaders header with as header field value a commaseparated list of the header field names from author request headers in lexicographical order each converted to ascii lowercase even when one or more are a simple header exclude the author request headers exclude user credentials exclude the request entity body the following request rules are to be observed while making the preflight request if the end user cancels the request apply the abort steps if the response has an http status code that is not in the xx range apply the network error steps the cache and network error steps are not used here as this is about an actual network error if there is a network error in case of dns errors tls negotiation failure or other type of network errors apply the network error steps do not request any kind of end user interaction this does not include http responses that indicate some type of error such as http status code  the cache and network error steps are not used here as this is about an actual network error otherwise the http status code is in the xx range if the resource sharing check returns fail apply the cache and network error steps let methods be the empty list if there are one or more accesscontrolallowmethods headers let methods be the values as result of parsing the headers if parsing failed apply the cache and network error steps if methods is still the empty list and the force preflight flag is set append the request method to methods this ensures that preflight requests that happened solely because of the force preflight flag are cached too let headers be the empty list if there are one or more accesscontrolallowheaders headers let headers be the values as result of parsing the headers if parsing failed apply the cache and network error steps if request method is not a casesensitive match for any method in methods and is not a simple method apply the cache and network error steps if the field name of each header in author request headers is not an ascii caseinsensitive match for one of the header field names in headers and the header is not a simple header apply the cache and network error steps if for some reason the user agent is unable to provide a preflight result cache eg because of limited disk space go to the next step in the overall set of steps ie the actual request if there is a single accesscontrolmaxage header parse it and let maxage be the resulting value if there is no such header there is more than one such header or parsing failed let maxage be a value at the discretion of the user agent zero is allowed if the user agent imposes a limit on the maxage field value and maxage is greater than that limit let maxage be the limit for each method in methods for which there is a method cache match set the maxage field value of the matching entry to maxage for each method in methods for which there is no method cache match create a new entry in the preflight result cache with the various fields set as follows origin the source origin url the request url maxage the maxage credentials false if the omit credentials flag is set or true otherwise method the given method header empty for each header in headers for which there is a header cache match set the maxage field value of the matching entry to maxage for each header in headers for which there is no header cache match create a new entry in the preflight result cache with the various fields set as follows origin the source origin url the request url maxage the maxage credentials false if the omit credentials flag is set or true otherwise method empty header the given header set the crossorigin request status to preflight complete this is the actual request apply the make a request steps and observe the request rules below while making the request if the response has an http status code of     or  apply the cache and network error steps if the end user cancels the request apply the abort steps if there is a network error in case of dns errors tls negotiation failure or other type of network errors apply the network error steps do not request any kind of end user interaction this does not include http responses that indicate some type of error such as http status code  otherwise perform a resource sharing check if it returns fail apply the cache and network error steps otherwise if it returns pass terminate this algorithm and set the crossorigin request status to success do not actually terminate the request consider the following scenario the user agent gets the request from an api such as xmlhttprequest to perform a crossorigin request using the custom xmodify method from source origin httpexampleorg to httpblogexampleentrieshelloworld the user agent performs a preflight request using the options method to httpblogexampleentrieshelloworld and includes the origin and accesscontrolrequestmethod headers with the appropriate values the response to that request includes the following headers accesscontrolalloworigin httpexampleorgaccesscontrolmaxage accesscontrolallowmethods put delete xmodify the user agent then performs the desired request using the xmodify method to httpblogexampleentrieshelloworld as this was allowed by the resource in addition for the coming fortytwo minutes no preflight request will be needed  preflight result cache as mentioned a crossorigin request with preflight uses a preflight result cache this cache consists of a set of entries each entry consists of the following fields origin holds the source origin url holds the request url maxage holds the accesscontrolmaxage header value credentials false if the omit credentials flag is set or true otherwise method empty if header is not empty otherwise one of the values from the accesscontrolallowmethods headers header empty if method is not empty otherwise one of the values from the accesscontrolallowheaders headers to be clear the method and header fields are mutually exclusive when one of them is empty the other is nonempty the primary key of an entry consists of all fields excluding the maxage field entries must be removed when the time specified in the maxage field has passed since storing the entry entries can also be added and removed per the algorithms below they are added and removed in such a way that there can never be duplicate items in the cache user agents may clear cache entries before the time specified in the maxage field has passed although this effectively makes the preflight result cache optional user agents are strongly encouraged to support it  generic crossorigin request algorithms the variables used in the generic set of steps are part of the algorithms that invoke these set of steps whenever the make a request steps are applied fetch the request url from origin source origin using referrer source as override referrer source with the manual redirect flag set and the block cookies flag set if the omit credentials flag is set use method request method entity body request entity body including the author request headers and include user credentials if the omit credentials flag is unset whenever the redirect steps are applied follow this set of steps let original url be the request url let request url be the url conveyed by the location header in the redirect response if the request url scheme is not supported infinite loop precautions are violated or the user agent does not wish to make the new request for some other reason apply the network error steps if the request url contains the userinfo production apply the network error steps if the resource sharing check for the current resource returns fail apply the network error steps if the request url origin is not same origin with the original url origin set source origin to a globally unique identifier becomes null when transmitted transparently follow the redirect while observing the set of request rules whenever the abort steps are applied terminate the algorithm that invoked this set of steps and set the crossorigin request status to abort error whenever the network error steps are applied terminate the algorithm that invoked this set of steps and set the crossorigin request status to network error this has no effect on setting of user credentials ie if the block cookies flag is unset cookies will be set by the response whenever the cache and network error steps are applied follow these steps remove the entries in the preflight result cache where origin field value is a casesensitive match for source origin and url field value is a casesensitive match for request url apply the network error steps acting as if the algorithm that invoked the cache and network error steps invoked the network error steps instead there is a cache match when there is a cache entry in the preflight result cache for which the following is true the origin field value is a casesensitive match for source origin the url field value is a casesensitive match for request url the credentials field value is true and the omit credentials flag is unset or it is false and the omit credentials flag is set there is a method cache match when there is a cache entry for which there is a cache match and the method field value is a casesensitive match for the given method there is a header cache match when there is a cache entry for which there is a cache match and the header field value is an ascii caseinsensitive match for the given header field name  resource sharing check the resource sharing check algorithm for a given resource is as follows if the response includes zero or more than one accesscontrolalloworigin header values return fail and terminate this algorithm if the accesscontrolalloworigin header value is the  character and the omit credentials flag is set return pass and terminate this algorithm if the value of accesscontrolalloworigin is not a casesensitive match for the value of the origin header as defined by its specification return fail and terminate this algorithm if the omit credentials flag is unset and the response includes zero or more than one accesscontrolallowcredentials header values return fail and terminate this algorithm if the omit credentials flag is unset and the accesscontrolallowcredentials header value is not a casesensitive match for true return fail and terminate this algorithm return pass the above algorithm also functions when the ascii serialization of an origin is the string null  security this section is nonnormative at various places user agents are allowed to take additional precautions eg user agents are allowed to not store cache items remove cache items before they reached their maxage and not connect to certain urls user agents are encouraged to impose a limit on maxage so items cannot stay in the preflight result cache for unreasonable amounts of time as indicated as the first step of the crossorigin request algorithm and in the redirect steps algorithm user agents are allowed to terminate the algorithm and not make a request this could be done because eg the origin of the resource blacklisted the origin of the resource is known to be part of an intranet the url scheme is not supported https to http is not allowed https is not allowed because of certificate errors user agents are encouraged to apply security decisions on a generic level and not just to the resource sharing policy eg if a user agent disallows requests from the https to the http scheme for a crossorigin request it is encouraged to do the same for the html img element  cors api specification advice this section is nonnormative this specification defines a resource sharing policy that cannot be implemented without an api that utilizes it the specification that defines the api that uses the policy is a cors api specification in case a cors api specification defines multiple apis that utilize the policy the advice is to be considered separately for each api  constructing a crossorigin request for all crossorigin requests that apis can make for which the resource sharing policy in this specification is supposed to apply the cors api specification needs to reference the crossorigin request algorithm and set the following input variables appropriately request url request method author request headers request entity body source origin manual redirect flag omit credentials flag and the force preflight flag cors api specifications are allowed to let these input variables be controlled by the api but can also set fixed values a cors api specification for an api that only allows requests using the get method might set request method to get request entity body to empty and source origin to some appropriate value and let the other variables be controlled by the api  dealing with same origin to crossorigin redirects since browsers are based on a same origin security model and the policy outlined in this specification is intended for apis used in browsers it is expected that apis that will utilize this policy will have to handle a same origin request that results in a redirect that is crossorigin in a special way for apis that transparently handle redirects cors api specifications are encouraged to handle this scenario transparently as well by catching the redirect and invoking the crossorigin request algorithm on the crossorigin redirect url the xmlhttprequest specification does this xhr  dealing with the crossorigin request status while a crossorigin request is progressing its associated crossorigin request status is updated depending on the value of the crossorigin request status the api is to react in a different way preflight complete features that can only be safely exposed after a preflight request can now be enabled eg upload progress events for xmlhttprequest success the contents of the response can be shared with the api including headers that have not been filtered out the request itself can still be progressing ie the crossorigin request status value does not indicate that the request has completed abort error handle analogous to requests where the user aborted the request this can be handled equivalently to how network error is handled ensure not to reveal any further information about the request network error handle analogous to requests where some kind of error occurred ensure not the reveal any further information about the request  security similarly to same origin requests cors api specifications are encouraged to properly limit headers methods and user credentials the author can set and get for requests that are crossorigin reviewing the xmlhttprequest specification provides a good start for the kind of limitations that are to be imposed xhr cors api specifications also need to ensure not to reveal anything until the crossorigin request status is set to preflight complete or success to prevent eg port scanning in xmlhttprequest progress events are dispatched only after the crossorigin request status is set to success upload progress events are only dispatched once the crossorigin request status is preflight complete references confused nonnormative the confused deputy norm hardy cookies http state management mechanism adam barth ietf csrf nonnormative crosssite request forgeries peter watkins eventsource nonnormative serversent events ian hickson wc html html berjon leithead navara oconnor pfeiffer and hickson wc http hypertext transfer protocol  http roy fielding james gettys jeffrey mogul et al ietf  the hypertext transfer protocol http status code  permanent redirect julian reschke ietf jsonp nonnormative jsonp bob ippolito oauth nonnormative the oauth  protocol eran hammerlahav ietf origin the web origin concept adam barth ietf rfc key words for use in rfcs to indicate requirement levels scott bradner ietf uri uniform resource identifier uri generic syntax tim bernerslee roy fielding and larry masinter ietf xhr nonnormative xmlhttprequest anne van kesteren wc acknowledgments this appendix is nonnormative the editor would like to thank adam barth alexey proskuryakov arne johannessen arthur barstow benjamin hawkeslewis bert bos bjrn hhrmann boris zbarsky brad hill cameron mccormack collin jackson david hsther david orchard dean jackson eric lawrence frank ellerman frederick hirsch graham klyne hal lockhart henri sivonen ian hickson jesse m heines jonas sicking julian reschke lachlan hunt  kanghao lu maciej stachowiak marc silbey marcos caceres mark nottingham mark s miller martin drst matt womer mhano harkness michael smith mohamed zergaoui nikunj mehta odin hrthe omdal philip jgenstedt sharath udupa simon pieters sunava dutta surya ismail thomas roessler tyler close jeff hodges vladimir dzhuvinov wayne carr and zhenbin xu for their contributions to this specification special thanks to brad porter matt oshry and r auburn who all helped editing earlier versions of this document